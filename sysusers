#!/bin/sh
# Copyright (c) 2017 - 2018 Chris Cromer
# Copyright (c) 2012 Gentoo Foundation
# Released under the 2-clause BSD license.
#
# This is an implementation of sysusers.d from systemd

error=0
# not called from systemd-sysusers
if [ ${systemd} -ne 1 ]; then
	replace=''
	root=''
	sysusers_basenames=''
	source @LIBDIR@/opensysusers/common.sh
fi

# this part is based on OpenRC's opentmpfiles
# Build a list of sorted unique basenames
# directories declared later in the sysusers_d array will override earlier
# directories, on a per file basename basis.
# `/etc/sysusers.d/foo.conf' supersedes `/usr/lib/sysusers.d/foo.conf'.
# `/run/sysusers.d/foo.conf' will always be read after `/etc/sysusers.d/bar.conf'
for dir in ${sysusers_dirs}; do
	[ -d "${dir}" ] && for file in "${dir}"/*.conf; do
		[ "${dir}" == "$(dirname ${replace})" ] && [ "${file##*/}" == "${replace##*/}" ] && continue
		[ -f "${file}" ] && sysusers_basenames="${sysusers_basenames}\n${file##*/}"
	done
done
FILES="$(printf "${sysusers_basenames}\n" | sort -u )"

sysusers_d=''

for b in ${FILES}; do
	real_f=''
	for d in ${sysusers_dirs}; do
		[ "${d}" == "$(dirname ${replace})" ] && [ "${b}" == "${replace##*/}" ] && continue
		f=${d}/${b}
		[ -f "${f}" ] && real_f="${f}"
	done
	[ -f "${real_f}" ] && sysusers_d="${sysusers_d} ${real_f}"
done

for file in ${sysusers_d}; do
	parse_file ${file}
done

exit ${error}
